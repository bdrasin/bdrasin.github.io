<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SessionStorage Test (Object/JSON Approach)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.5; }
        .data { font-size: 2em; font-weight: bold; margin: 10px 0; }
        button { padding: 10px 15px; margin-right: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>SessionStorage JSON Object Test</h1>

    <p>This page uses <code>sessionStorage</code> to save a counter value. The data is stored as a JSON string representing an object: <code>{ "value": 42 }</code>.</p>
    <p>Current value of **`value`**: <span id="currentValue" class="data">Loading...</span></p>

    <hr>

    <h2>Actions</h2>
    <button onclick="incrementValue()">Increment Value</button>
    <button onclick="clearStorage()">Clear sessionStorage</button>
    <button onclick="corruptStorage()">Corrupt Data for Test</button>
    
    <script>
        const STORAGE_KEY = 'mySessionData';
        const displayElement = document.getElementById('currentValue');

        /**
         * Safely retrieves and parses the data object from sessionStorage.
         * Handles missing or corrupted data by initializing a new object { value: 0 }.
         * @returns {object} The stored data object.
         */
        function loadData() {
            const jsonString = sessionStorage.getItem(STORAGE_KEY);
            let dataObject;

            if (jsonString) {
                try {
                    // 1. Attempt JSON.parse
                    dataObject = JSON.parse(jsonString);
                    
                    // Basic validation to ensure the object structure is correct
                    if (typeof dataObject.value !== 'number') {
                        throw new Error('Parsed object is missing a numerical "value" property.');
                    }
                } catch (e) {
                    // 2. Handle corrupted data (JSON parsing error or validation failure)
                    console.error("SessionStorage item was missing or corrupted. Initializing to 0.", e);
                    // Set it to a new object with value 0
                    dataObject = { value: 0 };
                }
            } else {
                // 3. Handle missing data (item not found)
                console.log("SessionStorage item not found. Initializing to 0.");
                // Set it to a new object with value 0
                dataObject = { value: 0 };
            }

            // Ensure the initialized/fixed object is saved back immediately
            saveData(dataObject);
            return dataObject;
        }

        /**
         * Converts the data object to a JSON string and saves it to sessionStorage.
         * @param {object} dataObject - The JavaScript object to store.
         */
        function saveData(dataObject) {
            // Use JSON.stringify before saving to sessionStorage
            const jsonString = JSON.stringify(dataObject);
            sessionStorage.setItem(STORAGE_KEY, jsonString);
            updateDisplay(dataObject.value);
        }

        /**
         * Increments the value and saves the new state.
         */
        function incrementValue() {
            const data = loadData();
            data.value += 1;
            saveData(data);
        }

        /**
         * Clears the sessionStorage item.
         */
        function clearStorage() {
            sessionStorage.removeItem(STORAGE_KEY);
            alert(`sessionStorage item '${STORAGE_KEY}' cleared!`);
            // Force a reload which will initialize the counter to 0
            window.location.reload(); 
        }

        /**
         * Corrupts the data by setting a non-JSON string, forcing a re-initialization on next load.
         */
        function corruptStorage() {
            sessionStorage.setItem(STORAGE_KEY, "This is not valid JSON and will cause an error!");
            alert("Data corrupted! Reload the page to test the error handling.");
            updateDisplay("CORRUPTED");
        }

        /**
         * Updates the text display on the page.
         * @param {number|string} value - The value to display.
         */
        function updateDisplay(value) {
            displayElement.textContent = value;
        }

        // Run immediately on load to display the initial state (read only)
        // and then perform the first update/save.
        document.addEventListener('DOMContentLoaded', () => {
            // Initial read and display
            loadData();
            
            // Start the loop
            setInterval(incrementValue, 10000); // Repeat every 10 seconds (10000ms)
        });
    </script>

</body>
</html>
